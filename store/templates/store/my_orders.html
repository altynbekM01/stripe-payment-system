<!DOCTYPE html>
<html>
<head>
  <title>My Orders</title>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

<h1>My Orders</h1>

{% for order in orders %}
  <div>
    <h3>Order #{{ order.id }} | {{ order.created_at }}</h3>
    <p>Currency: {{ order.currency.code }}</p>
    <button onclick="buyOrder({{ order.id }})">Оплатить заказ</button>
    <ul>
      {% for item in order.items.all %}
        <li>{{ item.name }} – {{ item.price }}</li>
      {% endfor %}
    </ul>
    <p>Total: {{ order.total_amount }}</p>
  </div>
{% empty %}
  <p>You have no orders.</p>
{% endfor %}

<script>
  const stripe = Stripe("{{ public_key }}");

  function buyOrder(orderId) {
    fetch(`/orders/${orderId}/buy/`)
      .then(response => response.json())
      .then(data => {
        if (data.id) {
          stripe.redirectToCheckout({ sessionId: data.id });
        } else {
          alert("Ошибка: " + (data.error || "Не удалось создать сессию"));
        }
      })
      .catch(error => {
        console.error("Ошибка при создании сессии:", error);
        alert("Произошла ошибка");
      });
  }
</script>

</body>
</html>
